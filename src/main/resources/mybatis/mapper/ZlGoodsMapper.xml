<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhiliao.hotel.mapper.ZlGoodsMapper">

    <resultMap id="BaseResultMap" type="com.zhiliao.hotel.model.ZlHotelgoodssku">
        <result column="HotelGoodsSkuID" jdbcType="INTEGER" property="hotelgoodsskuid" />
        <result column="SkuID" jdbcType="INTEGER" property="skuid" />
        <result column="GoodsID" jdbcType="INTEGER" property="goodsid" />
        <result column="HotelID" jdbcType="INTEGER" property="hotelid" />
        <result column="StockCount" jdbcType="INTEGER" property="stockcount" />
        <result column="SoldCount" jdbcType="INTEGER" property="soldcount" />
        <result column="VirtualSoldCount" jdbcType="INTEGER" property="virtualsoldcount" />
        <result column="IsDefault" jdbcType="BIT" property="isdefault" />
        <result column="IsDelete" jdbcType="BIT" property="isdelete" />
        <result column="CreateDate" jdbcType="INTEGER" property="createdate" />
        <result column="UpdateDate" jdbcType="INTEGER" property="updatedate" />
    </resultMap>

    <select id="findGoodsCategory" resultType="java.util.LinkedHashMap">
        select
            zgc.CategoryName,
            case zg.IsRecommand when 0 then '不推荐' when 1 then '推荐' end IsRecommand
        from zl_hotelgoodssku zhgs
        left join zl_goods zg on zhgs.GoodsID=zg.GoodsID
        left join zl_goodscategory zgc on zg.GoodsCategoryID=zgc.GoodsCategoryID
        where zhgs.IsDelete=0 and zhgs.IsDefault=1 and zg.GoodsStatus!='-1' and zgc.IsDelete=0 and zgc.CategoryStatus=1
        and zhgs.HotelID=#{hotelId} and zgc.BelongModule=#{belongModule}
        order by zgc.Sort asc
    </select>

    <select id="findGoodsList" resultType="com.zhiliao.hotel.controller.goods.vo.GoodsListVo">
        select
            zhgs.HotelGoodsSkuID,
            zhgs.GoodsID,
            zg.GoodsName,
            zg.CoverImgUrl,
            zg.OriginalPrice,
            zg.CurrentPrice,
            zhgs.SoldCount,
            zhgs.VirtualSoldCount
        from zl_hotelgoodssku zhgs
        left join zl_goods zg on zhgs.GoodsID=zg.GoodsID
        left join zl_goodscategory zgc on zg.GoodsCategoryID=zgc.GoodsCategoryID
        where zhgs.IsDelete=0 and zhgs.IsDefault=1 and zg.GoodsStatus!='-1' and zgc.IsDelete=0 and zgc.CategoryStatus=1
        and zhgs.HotelID=#{hotelId} and zgc.BelongModule=#{belongModule}
        <if test='categoryName!="all"'>
            <choose>
                <when test='categoryName=="推荐"'>
                    and zg.IsRecommand=1
                </when>
                <otherwise>
                    and zgc.CategoryName=#{categoryName}
                </otherwise>
            </choose>
        </if>
        order by zg.Sort asc
    </select>

    <select id="findGoodsSkuList" resultType="com.zhiliao.hotel.controller.goods.vo.GoodsSkuListVo">
        select
            zhgs.HotelGoodsSkuID,
            zgp.PropertyName,
            zgp.ImgUrl,
            zgs.OriginalPrice,
            zgs.CurrentPrice,
            zhgs.StockCount
        from zl_hotelgoodssku zhgs
        left join zl_goodssku zgs on zhgs.SkuID=zgs.SkuID
        left join zl_goodsproperty zgp on zgs.PropertyID=zgp.PropertyID
        where zhgs.IsDelete=0 and zgs.IsDelete=0 and zgp.IsDelete=0 and zhgs.HotelID=#{hotelId}
        and zhgs.GoodsID=#{goodsId}
        order by zgp.PropertyName desc
    </select>

    <select id="findGoodsDetail" resultType="com.zhiliao.hotel.controller.goods.vo.GoodsListVo">
        select
            GoodsID,
            CoverImgUrl,
            GoodsName,
            OriginalPrice,
            CurrentPrice,
            Content
        from zl_goods
        where GoodsStatus!='-1' and GoodsID=#{goodsId}
    </select>

    <update id="updateGoodsTotalVisitCount">
      update zl_goods set TotalVisitCount = TotalVisitCount + 1 where GoodsID = #{goodsId}
    </update>

    <select id="findRecommendGoodsList" resultType="com.zhiliao.hotel.controller.goods.vo.GoodsListVo">
        select
            zhgs.HotelGoodsSkuID,
            zhgs.GoodsID,
            zg.CoverImgUrl,
            zg.GoodsName,
            zg.OriginalPrice,
            zg.CurrentPrice,
            max(zhgs.SoldCount) SoldCount
        from zl_hotelgoodssku zhgs
        left join zl_goods zg on zhgs.GoodsID=zg.GoodsID
        where zhgs.IsDelete=0 and zg.GoodsStatus!='-1' and zg.IsRecommand=1 and zhgs.HotelID=#{hotelId}
        group by zhgs.GoodsID
        order by max(zhgs.SoldCount) desc,zg.Sort asc
        limit 50
    </select>

    <update id="updateGoods">
        UPDATE
          zl_goods
        SET
          TotalStockCount = TotalStockCount - #{goodsCount},
          TotalSoldCount = TotalSoldCount + #{goodsCount},
          RealtimeStockCount = RealtimeStockCount - #{goodsCount}
        WHERE GoodsID =
        (SELECT
            GoodsID
          FROM
            zl_hotelgoodssku
          WHERE HotelGoodsSkuID = #{hotelGoodsSkuID})
    </update>

    <update id="updateGoodsSku">
        UPDATE
          zl_goodssku
        SET
          StockCount = StockCount - #{goodsCount},
          SoldCount = SoldCount + #{goodsCount}
        WHERE SkuID =
        (SELECT
            SkuID
          FROM
            zl_hotelgoodssku
          WHERE HotelGoodsSkuID = #{hotelGoodsSkuID})
    </update>

    <update id="updateHotelGoodsSku">
        UPDATE
          zl_hotelgoodssku
        SET
          StockCount = StockCount - #{goodsCount},
          SoldCount = SoldCount + #{goodsCount}
        WHERE HotelGoodsSkuID = #{hotelGoodsSkuID}
    </update>

    <select id="getStockCount" resultType="integer">
        SELECT StockCount FROM zl_hotelgoodssku WHERE HotelID = #{hotelID} AND HotelGoodsSkuID = #{hotelGoodsSkuID}
    </select>

    <select id="findSkuCount" resultType="int">
        SELECT
          COUNT(HotelGoodsSkuID)
        FROM
          zl_hotelgoodssku
        WHERE GoodsID = #{goodsId}
    </select>

</mapper>